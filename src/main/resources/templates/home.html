<!DOCTYPE html>
<html lang = "en" layout:decorate = "~{layout}" xmlns:layout = "http://www.ultraq.net.nz/thymeleaf/layout">
    <head>
        <title>Home</title>
        <script src = "https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src = "https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    </head>
    <body>
        <section layout:fragment = "content">
            <div class = "preloader" style = "display: flex; justify-content: center; align-items: center">
                <img alt = "NTTeMOILogo" height = "50" src = "/images/NTTeMOILogo.png" width = "50">
            </div>
            <div class = "content-wrapper">
                <div class = "content-header">
                    <div class = "container-fluid">
                        <div class = "row mb-2">
                            <div class = "col-sm-6">
                                <h1 class = "m-0" id = "dynamic-title">Home</h1>
                            </div>
                            <div class = "col-sm-6">
                                <ol class = "breadcrumb float-sm-right">
                                    <li class = "breadcrumb-item active">Home</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                <section class = "content">
                    <div class = "container-fluid">
                        <div class = "row">
                            <div class = "col-12">
                                <div class = "card">
                                    <div class = "card-body">
                                        <form id = "dataForm">
                                            <div class = "form-row">
                                                <div class = "form-group col-md-6">
                                                    <label for = "month">Month</label>
                                                    <input class = "form-control form-control-sm" id = "month" name = "month" placeholder = "Enter month here" required type = "number">
                                                </div>
                                                <div class = "form-group col-md-6">
                                                    <label for = "year">Year</label>
                                                    <input class = "form-control form-control-sm" id = "year" name = "year" placeholder = "Enter year here" required type = "number">
                                                </div>
                                            </div>
                                            <button class = "btn btn-primary btn-block" type = "submit">Predict</button>
                                        </form>

                                        <div id = "split">
                                            <hr class = "border">
                                            <h2 id = "chart-title">Top Monthly Sales</h2>
                                        </div>

                                        <div id = "chartContainer" style = " height: 600px;">
                                            <canvas id = "myChart"></canvas>
                                        </div>
                                        <script>
                                            function updateTitle(month, year) {
                                                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                                                const formattedMonth = monthNames[month - 1];
                                                const title = `Top Monthly Sales for ${formattedMonth} ${year}`;
                                                document.getElementById('chart-title').textContent = title;
                                            }

                                            window.addEventListener('load', function () {
                                                const now = new Date();
                                                const month = now.getMonth() + 2;
                                                const year = now.getFullYear();

                                                document.getElementById('month').value = month;
                                                document.getElementById('year').value = year;

                                                updateTitle(month, year);

                                                fetch(`/send?month=${month}&year=${year}`)
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        data.sort((a, b) => b.Predict - a.Predict);
                                                        const limitedData = data.slice(0, 20);

                                                        const labels = limitedData.map(item => item.productName);
                                                        const predictValues = limitedData.map(item => item.Predict);
                                                        const avgQuantityValues = limitedData.map(item => item.avg_monthly);
                                                        const colors = limitedData.map(item => getColorForCategory(item.productCategory));

                                                        updateChart(labels, predictValues, avgQuantityValues, colors);
                                                    })
                                                    .catch(error => console.error('Error fetching data:', error));
                                            });

                                            document.getElementById('dataForm').addEventListener('submit', function (event) {
                                                event.preventDefault();
                                                const month = document.getElementById('month').value;
                                                const year = document.getElementById('year').value;

                                                updateTitle(month, year);

                                                fetch(`/send?month=${month}&year=${year}`)
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        data.sort((a, b) => b.Predict - a.Predict);
                                                        const limitedData = data.slice(0, 20);

                                                        const labels = limitedData.map(item => item.productName);
                                                        const predictValues = limitedData.map(item => item.Predict);
                                                        const avgQuantityValues = limitedData.map(item => item.avg_monthly);
                                                        const colors = limitedData.map(item => getColorForCategory(item.productCategory));

                                                        updateChart(labels, predictValues, avgQuantityValues, colors);
                                                    })
                                                    .catch(error => console.error('Error fetching data:', error));
                                            });

                                            function getColorForCategory(category) {
                                                const colorMap = {
                                                    'Electronics': 'rgba(255, 99, 132, 0.8)',
                                                    'Clothing': 'rgba(54, 162, 235, 0.8)',
                                                    'Toys': 'rgba(255, 206, 86, 0.8)',
                                                    'Food': 'rgba(75, 192, 192, 0.8)',
                                                    'Furniture': 'rgba(153, 102, 255, 0.8)',
                                                    'default': 'rgba(201, 203, 207, 0.8)'
                                                };
                                                return colorMap[category] || colorMap['default'];
                                            }

                                            function updateChart(labels, predictValues, avgQuantityValues, colors) {
                                                const ctx = document.getElementById('myChart').getContext('2d');

                                                if (window.myChart instanceof Chart) {
                                                    window.myChart.destroy();
                                                }

                                                window.myChart = new Chart(ctx, {
                                                    type: 'bar',
                                                    data: {
                                                        labels: labels,
                                                        datasets: [
                                                            {
                                                                label: 'Prediction Values',
                                                                data: predictValues,
                                                                backgroundColor: colors,
                                                                borderColor: colors.map(color => color.replace('0.8', '1')),
                                                                borderWidth: 1
                                                            },
                                                            {
                                                                label: 'Average Quantity',
                                                                data: avgQuantityValues,
                                                                backgroundColor: 'rgba(201, 203, 207, 0.8)',
                                                                borderColor: 'rgba(201, 203, 207, 1)',
                                                                borderWidth: 1
                                                            }
                                                        ]
                                                    },
                                                    options: {
                                                        responsive: true,
                                                        maintainAspectRatio: false,
                                                        plugins: {
                                                            legend: {
                                                                display: true,
                                                                labels: {
                                                                    generateLabels: function (chart) {
                                                                        const colorMap = {
                                                                            'Electronics': 'rgba(255, 99, 132, 0.8)',
                                                                            'Clothing': 'rgba(54, 162, 235, 0.8)',
                                                                            'Toys': 'rgba(255, 206, 86, 0.8)',
                                                                            'Food': 'rgba(75, 192, 192, 0.8)',
                                                                            'Furniture': 'rgba(153, 102, 255, 0.8)',
                                                                        };

                                                                        const legendItems = Object.entries(colorMap).map(([category, color]) => ({
                                                                            text: category,
                                                                            fillStyle: color,
                                                                            strokeStyle: color.replace('0.8', '1'),
                                                                            lineWidth: 1,
                                                                            hidden: false
                                                                        }));

                                                                        legendItems.push({
                                                                            text: 'Average Quantity',
                                                                            fillStyle: 'rgba(201, 203, 207, 0.8)',
                                                                            strokeStyle: 'rgba(201, 203, 207, 1)',
                                                                            lineWidth: 1,
                                                                            hidden: false
                                                                        });

                                                                        return legendItems;
                                                                    }
                                                                }
                                                            },
                                                            tooltip: {
                                                                callbacks: {
                                                                    label: function (context) {
                                                                        return `${context.dataset.label}: ${context.raw}`;
                                                                    }
                                                                }
                                                            },
                                                            datalabels: {
                                                                anchor: 'end',
                                                                align: 'top',
                                                                formatter: Math.round,
                                                                color: 'black',
                                                                font: {
                                                                    weight: 'bold'
                                                                }
                                                            }
                                                        },
                                                        scales: {
                                                            y: {
                                                                beginAtZero: true
                                                            }
                                                        }
                                                    },
                                                    plugins: [ChartDataLabels]
                                                });
                                            }
                                        </script>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </section>
    </body>
</html>